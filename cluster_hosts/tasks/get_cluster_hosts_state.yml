---

- block:
    - name: Get existing AWS instance info
      ec2_instance_info:
        filters:
          "tag:cluster_name": "{{cluster_name}}"
          "instance-state-name": ["running", "stopped"]
        aws_access_key: "{{cluster_vars[buildenv].aws_access_key}}"
        aws_secret_key: "{{cluster_vars[buildenv].aws_secret_key}}"
        region: "{{cluster_vars.region}}"
      register: r__ec2_instance_info
      delegate_to: localhost
      run_once: true

    - set_fact:
        cluster_hosts_state: "{{r__ec2_instance_info.instances | json_query(\"[].{name: tags.Name, regionzone: placement.availability_zone, tagslabels: tags, instance_id: instance_id, instance_state: state.name}\") }}"
  when: cluster_vars.type == "aws"

- block:
    - name: Get existing GCP instance info (per AZ)
      gcp_compute_instance_info:
        zone: "{{cluster_vars.region}}-{{item}}"
        filters:
          - "labels.cluster_name = {{cluster_name}}"
        project: "{{cluster_vars.project_id}}"
        auth_kind: "serviceaccount"
        service_account_file: "{{gcp_credentials_file}}"
        scopes: ["https://www.googleapis.com/auth/compute.readonly"]
      with_items: "{{ cluster_vars[buildenv].hosttype_vars | json_query(\"*[vms_by_az][][keys(@)][][]\") | unique }}"
      register: r__gcp_compute_instance_info
      delegate_to: localhost
      run_once: true

    - set_fact:
        cluster_hosts_state: |
          {% set res = _pre_cluster_hosts_state -%}
            {%- for cluster_host in res -%}
               {%- set _ = cluster_host.update({'regionzone': cluster_host.regionzone | regex_replace('^.*/(.*)$', '\\1') }) -%}
            {%- endfor -%}
          {{ res }}
      vars:
        _pre_cluster_hosts_state: "{{r__gcp_compute_instance_info.results | json_query(\"[?resources[?labels]].resources[].{name: name, regionzone: zone, tagslabels: labels, instance_id: id, instance_state: status}\") }}"
  when: cluster_vars.type == "gce"

- block:
    - name: Get existing VMware instance info
      vmware_vm_info:
        username: "{{ cluster_vars.esxi_username }}"
        password: "{{ cluster_vars.esxi_password }}"
        hostname: "{{ cluster_vars.esxi_ip }}"
        validate_certs: no
      register: r__vmware_vm_info
      delegate_to: localhost
      run_once: true

    - name: Get existing VMware instance facts
      vmware_guest_info:
        username: "{{ cluster_vars.esxi_username }}"
        password: "{{ cluster_vars.esxi_password }}"
        hostname: "{{ cluster_vars.esxi_ip }}"
        validate_certs: no
        datacenter: None
        uuid: "{{item.uuid}}"
      with_items: "{{ r__vmware_vm_info.virtual_machines | to_json | from_json | json_query(\"[?starts_with(guest_name, '\"+cluster_name+\"')]\") }}"
      register: r__vmware_guest_info
      delegate_to: localhost
      run_once: true

    # Convert the annotations into a proper dictionary within the facts
    - set_fact:
        r__vmware_guest_info: |
          {% set res = r__vmware_guest_info -%}
            {%- for result in r__vmware_guest_info.results -%}
               {%- set _ = result.instance.update({'annotation': result.instance.annotation | json_loads_loose}) -%}
            {%- endfor -%}
          {{ res }}

    - set_fact:
        cluster_hosts_state: "{{ r__vmware_guest_info.results | json_query(\"[].{name: instance.hw_name, regionzone: None, tagslabels: instance.annotation, instance_id: instance.moid, instance_state: instance.hw_power_status}\") }}"
  when: cluster_vars.type == "esxifree"

- name: cluster_hosts_state
  debug: msg="{{cluster_hosts_state}}"
  when: cluster_hosts_state is defined

- set_fact:
    cluster_suffixes_current: "{{ cluster_hosts_state | json_query(\"[?tagslabels.lifecycle_state=='current'].tagslabels.cluster_suffix\") }}"

- assert: { that: "cluster_suffixes_current | unique | length <= 1", msg: "Multiple current suffixes running ({{cluster_suffixes_current | join(',')}}) - abort" }
  when: cluster_suffixes_current is defined

- set_fact:
    cluster_suffix_current: "{{ cluster_suffixes_current[0] | default('') }}"

- debug: msg="cluster_suffix_current = {{ cluster_suffix_current | default('') }}"
