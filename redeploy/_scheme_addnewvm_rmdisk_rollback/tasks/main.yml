---

- name: Preflight check
  block:
    - assert: { that: "non_current_hosts | length == 0", msg: "ERROR - All VMs must be in the 'current' lifecycle_state.  Those not [{{non_current_hosts | join(',')}}]"  }
      vars:
        non_current_hosts: "{{ cluster_hosts_state | json_query(\"[?tagslabels.lifecycle_state!='current'].name\") }}"
      when: canary=="start" or canary=="none"


- name: Redeploy by hosttype; rollback on fail
  block:
    - name: Change lifecycle_state label from 'current' to 'retiring'
      import_role:
        name: clusterverse/redeploy/__common
        tasks_from: set_lifecycle_state_label.yml
      vars:
        hosts_to_relabel: "{{ cluster_hosts_state | json_query(\"[?tagslabels.lifecycle_state=='current']\") }}"
        new_state: "retiring"
      when: (canary=="start" or canary=="none") and ('retiring' not in (cluster_hosts_state | map(attribute='tagslabels.lifecycle_state')))

    - name: re-acquire cluster_hosts_flat and cluster_hosts_state
      import_role:
        name: clusterverse/cluster_hosts

    - name: Run redeploy per hosttype.  Create one at a time, then stop previous.
      include_tasks: redeploy_by_hosttype.yml
      with_items: "{{ myhosttypes_array }}"
      loop_control:
        loop_var: hosttype
      vars:
        cluster_hosts_flat_by_hosttype: "{{cluster_hosts_flat | dict_agg('hosttype')}}"
        myhosttypes_array: "{%- if myhosttypes is defined -%} {{ myhosttypes.split(',') }} {%- else -%} {{ cluster_hosts_flat_by_hosttype.keys() | list }} {%- endif -%}"

  rescue:
    - debug: msg="Rescuing"

    - name: rescue
      include_tasks: rescue.yml

    - name: rescue | end_play
      meta: end_play
  when: canary!="tidy"


- name: Tidy up non-current instances
  block:
    - assert: { that: "'current' in (cluster_hosts_state | map(attribute='tagslabels.lifecycle_state'))", msg: "ERROR - Cannot tidy when there are no machines in the 'current' lifecycle_state." }

    - import_role:
        name: clusterverse/clean
        tasks_from: clean_dns.yml
      when: (cluster_vars.dns_server is defined and cluster_vars.dns_server != "") and (cluster_vars.dns_zone_external is defined and cluster_vars.dns_zone_external != "")

    - import_role:
        name: clusterverse/clean
        tasks_from: clean_vms.yml
  vars:
    hosts_to_clean: "{{ cluster_hosts_state | json_query(\"[?tagslabels.lifecycle_state!='current']\") }}"
  when: canary=="tidy" or  ((canary=="none" or canary=="finish") and canary_tidy_on_success is defined and canary_tidy_on_success|bool)

